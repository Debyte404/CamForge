# CI Pipeline for CamForge
# Runs on all PRs and pushes to main
# Validates code quality and builds firmware

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # Build Job - Compile firmware for all targets
  # ============================================
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        environment: [esp32s3, esp32dev]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ matrix.environment }}-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ matrix.environment }}-
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
      
      - name: Build
        run: pio run -e ${{ matrix.environment }}
      
      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v6
        with:
          name: firmware-${{ matrix.environment }}
          path: .pio/build/${{ matrix.environment }}/firmware.bin
          retention-days: 7

  # ============================================
  # Code Quality - Static Analysis
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck
      
      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,style,performance \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --error-exitcode=0 \
            --inline-suppr \
            -I include \
            -I src \
            src/ 2>&1 | tee cppcheck-report.txt
      
      - name: Upload cppcheck Report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: cppcheck-report
          path: cppcheck-report.txt

  # ============================================
  # Documentation Check
  # ============================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check Required Files
        run: |
          echo "Checking required documentation files..."
          files=("README.md" "LICENSE" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md")
          missing=0
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              missing=1
            else
              echo "✅ Found: $file"
            fi
          done
          # Don't fail for now, just warn
          if [ $missing -eq 1 ]; then
            echo "::warning::Some documentation files are missing"
          fi
      
      - name: Check README Links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/mlc_config.json'
        continue-on-error: true

  # ============================================
  # Security Scan
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities for now

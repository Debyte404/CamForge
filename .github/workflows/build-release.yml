# Build & Release Firmware for CamForge
# Automatically builds and creates GitHub Releases with firmware binaries
# when a version tag (vX.Y.Z) is pushed.
#
# USAGE:
#   git tag v1.1.0
#   git push origin v1.1.0
#
# The ESP32 devices will then auto-detect and download the new firmware.

name: Build & Release Firmware

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

env:
  PLATFORMIO_CORE_DIR: .pio

jobs:
  build:
    name: Build ESP32-S3 Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
      
      - name: Build Firmware
        run: |
          pio run -e esp32s3
          
      - name: Rename Firmware with Version
        run: |
          VERSION=${{ github.ref_name }}
          cp .pio/build/esp32s3/firmware.bin ./CamForge-${VERSION}.bin
          echo "Built CamForge-${VERSION}.bin"
          ls -la *.bin
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            CamForge-*.bin
          generate_release_notes: true
          body: |
            ## ðŸ“¸ CamForge Firmware ${{ github.ref_name }}
            
            ### Installation
            
            **Automatic OTA:**
            Your CamForge device will automatically detect this update within 2 hours.
            
            **Manual OTA:**
            1. Open your browser to `http://<device-ip>/ota`
            2. Click "Check for Updates"
            3. Click "Install Update"
            
            **Serial Flash:**
            ```bash
            pio run -e esp32s3 -t upload
            ```
            
            ### Changes
            See auto-generated release notes below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Artifact (for PRs/manual builds)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: .pio/build/esp32s3/firmware.bin
          retention-days: 7
